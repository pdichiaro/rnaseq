includeConfig "../../modules/local/multiqc_custom_biotype/nextflow.config"
includeConfig "../../modules/nf-core/bbmap/bbsplit/nextflow.config"
includeConfig "../../modules/nf-core/cat/fastq/nextflow.config"
includeConfig "../../modules/nf-core/dupradar/nextflow.config"
includeConfig "../../modules/nf-core/multiqc/nextflow.config"
includeConfig "../../modules/nf-core/preseq/lcextrap/nextflow.config"
includeConfig "../../modules/nf-core/qualimap/rnaseq/nextflow.config"
includeConfig "../../modules/nf-core/sortmerna/nextflow.config"
includeConfig "../../modules/nf-core/stringtie/stringtie/nextflow.config"
includeConfig "../../modules/nf-core/subread/featurecounts/nextflow.config"
includeConfig "../../modules/nf-core/kraken2/kraken2/nextflow.config"
includeConfig "../../modules/nf-core/bracken/bracken/nextflow.config"
includeConfig "../../subworkflows/local/align_star/nextflow.config"
includeConfig "../../subworkflows/local/quantify_rsem/nextflow.config"
includeConfig "../../subworkflows/nf-core/quantify_pseudo_alignment/nextflow.config"
includeConfig "../../subworkflows/nf-core/bam_markduplicates_picard/nextflow.config"
includeConfig "../../subworkflows/nf-core/bam_rseqc/nextflow.config"
includeConfig "../../subworkflows/nf-core/fastq_align_hisat2/nextflow.config"
includeConfig "../../subworkflows/nf-core/fastq_fastqc_umitools_fastp/nextflow.config"
includeConfig "../../subworkflows/nf-core/fastq_fastqc_umitools_trimgalore/nextflow.config"
includeConfig "../../subworkflows/nf-core/fastq_subsample_fq_salmon/nextflow.config"
includeConfig "../../subworkflows/nf-core/fastq_qc_trim_filter_setstrandedness/nextflow.config"

//
// STAR Salmon alignment options
//

if (params.with_umi) {
        process {
            withName: 'NFCORE_RNASEQ:RNASEQ:BAM_DEDUP_UMI_(STAR|HISAT2):SAMTOOLS_SORT' {
                ext.args   = '-n'
                ext.prefix = { "${meta.id}.umi_dedup.transcriptome" }
                publishDir = [
                    path: { params.save_align_intermeds || params.save_umi_intermeds ? "${params.outdir}/${params.aligner}" : params.outdir },
                    mode: params.publish_dir_mode,
                    pattern: '*.bam',
                    saveAs: { params.save_align_intermeds || params.save_umi_intermeds ? it : null }
                ]
            }

            withName: 'NFCORE_RNASEQ:RNASEQ:BAM_DEDUP_UMI_(STAR|HISAT2):UMITOOLS_PREPAREFORRSEM' {
                ext.prefix = { "${meta.id}.umi_dedup.transcriptome.filtered" }
                publishDir = [
                    [
                        path: { "${params.outdir}/${params.aligner}/umitools/prepare_for_salmon_log" },
                        mode: params.publish_dir_mode,
                        pattern: '*.log'
                    ],
                    [
                        path: { params.save_align_intermeds || params.save_umi_intermeds ? "${params.outdir}/${params.aligner}" : params.outdir },
                        mode: params.publish_dir_mode,
                        pattern: '*.bam',
                        saveAs: { params.save_align_intermeds || params.save_umi_intermeds ? it : null }
                    ]
                ]
            }

            withName: 'NFCORE_RNASEQ:RNASEQ:BAM_DEDUP_UMI_STAR:BAM_SORT_STATS_SAMTOOLS:SAMTOOLS_SORT' {
                ext.prefix = { "${meta.id}.transcriptome.sorted" }
                publishDir = [
                    path: { params.save_align_intermeds || params.save_umi_intermeds ? "${params.outdir}/${params.aligner}" : params.outdir },
                    mode: params.publish_dir_mode,
                    pattern: '*.bam',
                    saveAs: { params.save_align_intermeds || params.save_umi_intermeds ? it : null }
                ]
            }

            withName: 'NFCORE_RNASEQ:RNASEQ:BAM_DEDUP_UMI_STAR:BAM_SORT_STATS_SAMTOOLS:SAMTOOLS_INDEX' {
                publishDir = [
                    path: { params.save_align_intermeds || params.save_umi_intermeds ? "${params.outdir}/${params.aligner}" : params.outdir },
                    mode: params.publish_dir_mode,
                    pattern: '*.bai',
                    saveAs: { params.save_align_intermeds || params.save_umi_intermeds ? it : null }
                ]
            }

            withName: 'NFCORE_RNASEQ:RNASEQ:BAM_DEDUP_UMI_STAR:BAM_SORT_STATS_SAMTOOLS:BAM_STATS_SAMTOOLS:.*' {
                ext.prefix = { "${meta.id}.transcriptome.sorted.bam" }
                publishDir = [
                    path: { params.save_align_intermeds || params.save_umi_intermeds ? "${params.outdir}/${params.aligner}/samtools_stats" : params.outdir },
                    mode: params.publish_dir_mode,
                    pattern: '*.{stats,flagstat,idxstats}',
                    saveAs: { params.save_align_intermeds || params.save_umi_intermeds ? it : null }
                ]
            }

            // Use the same umi_dedup prefix for umitools and umicollapse

            withName: '.*:BAM_DEDUP_STATS_SAMTOOLS_UMI(COLLAPSE|TOOLS)_TRANSCRIPTOME:UMI(COLLAPSE|TOOLS_DEDUP)' {
                ext.prefix = { "${meta.id}.umi_dedup.transcriptome.sorted" }
            }

            // Publishing logic for umitools:

            withName: '.*:BAM_DEDUP_STATS_SAMTOOLS_UMITOOLS_TRANSCRIPTOME:UMITOOLS_DEDUP' {
                publishDir = [
                    [
                        path: { params.save_align_intermeds || params.save_umi_intermeds ? "${params.outdir}/${params.aligner}" : params.outdir },
                        mode: params.publish_dir_mode,
                        pattern: '*.bam',
                        saveAs: { params.save_align_intermeds || params.save_umi_intermeds ? it : null }
                    ],
                    [
                        path: { "${params.outdir}/${params.aligner}/umitools/transcriptomic_dedup_log" },
                        mode: params.publish_dir_mode,
                        pattern: '*.log'
                    ],
                    [
                        path: { "${params.outdir}/${params.aligner}/umitools" },
                        mode: params.publish_dir_mode,
                        pattern: '*.tsv'
                    ]
                ]
            }

            // Publishing logic for umicollapse

            withName: '.*:BAM_DEDUP_STATS_SAMTOOLS_UMICOLLAPSE_TRANSCRIPTOME:UMICOLLAPSE' {
                publishDir = [
                    [
                        path: { params.save_align_intermeds || params.save_umi_intermeds ? "${params.outdir}/${params.aligner}" : params.outdir },
                        mode: params.publish_dir_mode,
                        pattern: '*.bam',
                        saveAs: { params.save_align_intermeds || params.save_umi_intermeds ? it : null }
                    ],
                    [
                        path: { "${params.outdir}/${params.aligner}/umicollapse/transcriptomic_dedup_log" },
                        mode: params.publish_dir_mode,
                        pattern: '*.log'
                    ]
                ]
            }

            withName: '.*:BAM_DEDUP_STATS_SAMTOOLS_UMI(COLLAPSE|TOOLS)_TRANSCRIPTOME:SAMTOOLS_INDEX' {
                publishDir = [
                    path: { params.save_align_intermeds || params.save_umi_intermeds ? "${params.outdir}/${params.aligner}" : params.outdir },
                    mode: params.publish_dir_mode,
                    pattern: '*.bai',
                    saveAs: { params.save_align_intermeds || params.save_umi_intermeds ? it : null }
                ]
            }

            withName: '.*:BAM_DEDUP_STATS_SAMTOOLS_UMI(COLLAPSE|TOOLS)_TRANSCRIPTOME:BAM_STATS_SAMTOOLS:.*' {
                ext.prefix = { "${meta.id}.umi_dedup.transcriptome.sorted.bam" }
                publishDir = [
                    path: { "${params.outdir}/${params.aligner}/samtools_stats" },
                    mode: params.publish_dir_mode,
                    pattern: '*.{stats,flagstat,idxstats}'
                ]
            }
        }
}

//
// General alignment options
//

process {
    withName: 'NFCORE_RNASEQ:RNASEQ:.*:BAM_SORT_STATS_SAMTOOLS:BAM_STATS_SAMTOOLS:.*' {
        ext.prefix = { "${meta.id}.sorted.bam" }
        publishDir = [
            path: { "${params.outdir}/${params.aligner}/samtools_stats" },
            mode: params.publish_dir_mode,
            pattern: "*.{stats,flagstat,idxstats}"
        ]
    }

    withName: 'NFCORE_RNASEQ:RNASEQ:.*:BAM_SORT_STATS_SAMTOOLS:SAMTOOLS_SORT' {
        ext.prefix = { "${meta.id}.sorted" }
        publishDir = [
            path: { ( ['star','hisat2'].contains(params.aligner) &&
                    ( params.save_align_intermeds || ( !params.with_umi && params.skip_markduplicates ) )
                ) || params.save_align_intermeds || params.skip_markduplicates ? "${params.outdir}/${params.aligner}/${meta.id}" : params.outdir },
            mode: params.publish_dir_mode,
            pattern: "*.bam",
            saveAs: { ( ['star','hisat2'].contains(params.aligner) &&
                    ( params.save_align_intermeds || ( !params.with_umi && params.skip_markduplicates ) )
                ) || params.save_align_intermeds || params.skip_markduplicates ? it : null }
        ]
    }

    withName: 'NFCORE_RNASEQ:RNASEQ:.*:BAM_SORT_STATS_SAMTOOLS:SAMTOOLS_INDEX' {
        ext.args   = { params.bam_csi_index ? '-c' : '' }
        publishDir = [
            path: { ( ['star','hisat2'].contains(params.aligner) &&
                    ( params.save_align_intermeds || ( !params.with_umi && params.skip_markduplicates ) )
                ) || params.save_align_intermeds || params.skip_markduplicates ? "${params.outdir}/${params.aligner}/${meta.id}" : params.outdir },
            mode: params.publish_dir_mode,
            pattern: "*.{bai,csi}",
            saveAs: { ( ['star','hisat2'].contains(params.aligner) &&
                    ( params.save_align_intermeds || ( !params.with_umi && params.skip_markduplicates ) )
                ) || params.save_align_intermeds || params.skip_markduplicates ? it : null }
        ]
    }
}

if (params.with_umi && ['star','hisat2'].contains(params.aligner)) {
    process {

        withName: '.*:BAM_DEDUP_STATS_SAMTOOLS_UMITOOLS_(GEN|TRANSCRIPT)OME:UMITOOLS_DEDUP' {
            ext.args = { [
                meta.single_end                 ? '' : '--unpaired-reads=discard --chimeric-pairs=discard',
                params.umitools_grouping_method ? "--method='${params.umitools_grouping_method}'" : '',
                params.umitools_umi_separator   ? "--umi-separator='${params.umitools_umi_separator}'" : ''
            ].join(' ').trim() }
        }

        withName: '.*:BAM_DEDUP_STATS_SAMTOOLS_UMICOLLAPSE_(GEN|TRANSCRIPT)OME:UMICOLLAPSE' {
            ext.args = { [
                '--two-pass',
                meta.single_end                 ? '' : '--paired --remove-unpaired --remove-chimeric',
                params.umitools_grouping_method ? "--algo '" + ['directional':'dir','adjacency':'adj','cluster':'cc'].get(params.umitools_grouping_method, '') + "'" : '',
                params.umitools_umi_separator   ? "--umi-sep '${params.umitools_umi_separator}'" : '',
            ].join(' ').trim()}
        }

        // Use the same umi_dedup prefix for umitools and umicollapse

        withName: '.*:BAM_DEDUP_STATS_SAMTOOLS_UMI(COLLAPSE|TOOLS)_GENOME:UMI(COLLAPSE|TOOLS_DEDUP)' {
            ext.prefix = { "${meta.id}.umi_dedup.sorted" }
        }

        // Publishing logic for umitools:

        withName: '.*:BAM_DEDUP_STATS_SAMTOOLS_UMITOOLS_GENOME:UMITOOLS_DEDUP' {
            publishDir = [
                [
                    path: { params.save_align_intermeds || params.save_umi_intermeds ? "${params.outdir}/${params.aligner}" : params.outdir },
                    mode: params.publish_dir_mode,
                    pattern: '*.bam',
                    saveAs: { params.save_align_intermeds || params.save_umi_intermeds ? it : null }
                ],
                [
                    path: { "${params.outdir}/${params.aligner}/umitools/genomic_dedup_log" },
                    mode: params.publish_dir_mode,
                    pattern: '*.log'
                ],
                [
                    path: { "${params.outdir}/${params.aligner}/umitools" },
                    mode: params.publish_dir_mode,
                    pattern: '*.tsv'
                ]
            ]
        }

        // Publishing logic for umicollapse

        withName: '.*:BAM_DEDUP_STATS_SAMTOOLS_UMICOLLAPSE_GENOME:UMICOLLAPSE' {
            publishDir = [
                [
                    path: { params.save_align_intermeds || params.save_umi_intermeds ? "${params.outdir}/${params.aligner}" : params.outdir },
                    mode: params.publish_dir_mode,
                    pattern: '*.bam',
                    saveAs: { params.save_align_intermeds || params.save_umi_intermeds ? it : null }
                ],
                [
                    path: { "${params.outdir}/${params.aligner}/umicollapse/genomic_dedup_log" },
                    mode: params.publish_dir_mode,
                    pattern: '*.log'
                ]
            ]
        }

        withName: '.*:BAM_DEDUP_STATS_SAMTOOLS_UMI(COLLAPSE|TOOLS)_GENOME:SAMTOOLS_INDEX' {
            ext.args   = { params.bam_csi_index ? '-c' : '' }
            ext.prefix = { "${meta.id}.umi_dedup.sorted" }
            publishDir = [
                path: { params.save_align_intermeds || params.save_umi_intermeds ? "${params.outdir}/${params.aligner}" : params.outdir },
                mode: params.publish_dir_mode,
                pattern: '*.{bai,csi}',
                saveAs: { params.save_align_intermeds || params.save_umi_intermeds ? it : null }
            ]
        }

        withName: '.*:BAM_DEDUP_STATS_SAMTOOLS_UMI(COLLAPSE|TOOLS)_GENOME:BAM_STATS_SAMTOOLS:.*' {
            ext.prefix = { "${meta.id}.umi_dedup.sorted.bam" }
            publishDir = [
                path: { "${params.outdir}/${params.aligner}/samtools_stats" },
                mode: params.publish_dir_mode,
                pattern: '*.{stats,flagstat,idxstats}'
            ]
        }
    }
}

//
// bigWig coverage options
//
if (!params.skip_bigwig) {
    process {
        withName: 'BEDTOOLS_GENOMECOV_FW' {
            ext.prefix = { meta.strandedness == 'reverse' ? meta.id + '.reverse' :  meta.id + '.forward' }
            ext.args   = '-split -du -strand + -bg'
            publishDir = [
                enabled: false
            ]
        }

        withName: 'BEDTOOLS_GENOMECOV_REV' {
            ext.prefix = { meta.strandedness == 'reverse' ? meta.id + '.forward' :  meta.id + '.reverse' }
            ext.args   = '-split -du -strand - -bg'
            publishDir = [
                enabled: false
            ]
        }

        withName: 'BEDTOOLS_GENOMECOV_UNSTRANDED' {
            ext.prefix = { meta.id + '.unstranded' }
            ext.args   = '-split -du -bg'
            publishDir = [
                enabled: false
            ]
        }

        withName: '.*:BEDGRAPH_BEDCLIP_BEDGRAPHTOBIGWIG_FORWARD:UCSC_BEDCLIP' {
            ext.prefix = { "${meta.id}.clip.forward" }
            publishDir = [
                enabled: false
            ]
        }

        withName: '.*:BEDGRAPH_BEDCLIP_BEDGRAPHTOBIGWIG_FORWARD:UCSC_BEDGRAPHTOBIGWIG' {
            ext.prefix = { "${meta.id}.forward" }
            publishDir = [
                path: { "${params.outdir}/${params.aligner}/bigwig" },
                mode: params.publish_dir_mode,
                saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
            ]
        }

        withName: '.*:BEDGRAPH_BEDCLIP_BEDGRAPHTOBIGWIG_REVERSE:UCSC_BEDCLIP' {
            ext.prefix = { "${meta.id}.clip.reverse" }
            publishDir = [
                enabled: false
            ]
        }

        withName: '.*:BEDGRAPH_BEDCLIP_BEDGRAPHTOBIGWIG_REVERSE:UCSC_BEDGRAPHTOBIGWIG' {
            ext.prefix = { "${meta.id}.reverse" }
            publishDir = [
                path: { "${params.outdir}/${params.aligner}/bigwig" },
                mode: params.publish_dir_mode,
                saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
            ]
        }

        withName: '.*:BEDGRAPH_BEDCLIP_BEDGRAPHTOBIGWIG_UNSTRANDED:UCSC_BEDCLIP' {
            ext.prefix = { "${meta.id}.clip.unstranded" }
            publishDir = [
                enabled: false
            ]
        }

        withName: '.*:BEDGRAPH_BEDCLIP_BEDGRAPHTOBIGWIG_UNSTRANDED:UCSC_BEDGRAPHTOBIGWIG' {
            ext.prefix = { "${meta.id}.unstranded" }
            publishDir = [
                path: { "${params.outdir}/${params.aligner}/bigwig" },
                mode: params.publish_dir_mode,
                saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
            ]
        }
    }
}

//
// DESeq2 QC options
//
if (params.aligner == 'star' && params.quantification == 'rsem') {
    if (!(params.skip_qc ?: false) & !(params.skip_deseq2_qc ?: false)) {
        process {
            withName: '.*:NORMALIZE_DESEQ2_QC_ALL_GENES.*' {
                publishDir = [
                    path: { "${params.outdir}/${params.aligner}/rsem/deseq2/all_genes" },
                    mode: params.publish_dir_mode,
                    pattern: "*{RData,pca.vals.txt,plots.pdf,sample.dists.txt,size_factors,log,normalized_counts.txt,rlog_counts.txt,scaling_dat.txt,correlation_mqc.tsv,read_dist_mqc.tsv,pca.vals_mqc.tsv,sample.dists_mqc.tsv,Read_Distribution,Quality_Control,scaling_factors}"
                ]
            }
            withName: '.*:NORMALIZE_DESEQ2_QC_INVARIANT_GENES.*' {
                publishDir = [
                    path: { "${params.outdir}/${params.aligner}/rsem/deseq2/invariant_genes" },
                    mode: params.publish_dir_mode,
                    pattern: "*{RData,pca.vals.txt,plots.pdf,sample.dists.txt,size_factors,log,normalization,normalized_counts.txt,normalized_filt.txt,scaling_dat.txt,correlation_mqc.tsv,read_dist_mqc.tsv,pca.vals_mqc.tsv,sample.dists_mqc.tsv,Read_Distribution,Quality_Control,scaling_factors}"
                ]
            }
        }
    }
}

//
// General STAR QC options (common for all quantification methods)
//

if (params.aligner == 'star') {
    process {
        // RSeQC outputs
        withName: '.*:BAM_RSEQC:RSEQC_.*' {
            publishDir = [
                path: { "${params.outdir}/${params.aligner}/rseqc" },
                mode: params.publish_dir_mode,
                pattern: "*{.txt,.log,.xls,.r,.R,.pdf,.bed}"
            ]
        }

        // Qualimap outputs
        withName: '.*:QUALIMAP_RNASEQ' {
            publishDir = [
                path: { "${params.outdir}/${params.aligner}/qualimap" },
                mode: params.publish_dir_mode,
                pattern: "*rnaseq_qc_results*{,/}"
            ]
        }

        // dupRadar outputs  
        withName: '.*:DUPRADAR' {
            publishDir = [
                path: { "${params.outdir}/${params.aligner}/dupradar" },
                mode: params.publish_dir_mode,
                pattern: "*{.txt,.pdf}"
            ]
        }

        // StringTie outputs
        withName: '.*:STRINGTIE_STRINGTIE' {
            publishDir = [
                path: { "${params.outdir}/${params.aligner}/stringtie" },
                mode: params.publish_dir_mode,
                pattern: "*{.gtf,.ballgown,.abundance.txt,.cov_refs.txt}"
            ]
        }

        // BigWig outputs
        withName: '.*:BEDGRAPH_BEDCLIP_BEDGRAPHTOBIGWIG_.*' {
            publishDir = [
                path: { "${params.outdir}/${params.aligner}/bigwig" },
                mode: params.publish_dir_mode,
                pattern: "*.bigWig"
            ]
        }

        // SAMtools stats  
        withName: '.*:BAM_SORT_STATS_SAMTOOLS:SAMTOOLS_STATS' {
            publishDir = [
                path: { "${params.outdir}/${params.aligner}/samtools_stats" },
                mode: params.publish_dir_mode,
                pattern: "*{.flagstat,.idxstats,.stats}"
            ]
        }
    }
}

//
// STAR Genome quantification options
//

//
// Genome quantification options (STAR and HISAT2)
//

if ((['star', 'hisat2'].contains(params.aligner)) && params.quantification == 'genome') {
    process {
        withName: '.*:GENOME_COUNT' {
            publishDir = [
                path: { "${params.outdir}/${params.aligner}/genome/${meta.id}" },
                mode: params.publish_dir_mode,
                saveAs: { filename -> 
                    if (filename.equals('versions.yml') || filename.endsWith('_counts.rds')) {
                        return null
                    }
                    return filename
                }
            ]
        }

        withName: '.*:MERGE_GENOME_COUNTS' {
            publishDir = [
                path: { "${params.outdir}/${params.aligner}/genome" },
                mode: params.publish_dir_mode,
                saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
            ]
        }
        
        withName: '.*:MERGE_GENOME_COUNTS_HISAT2' {
            publishDir = [
                path: { "${params.outdir}/${params.aligner}/genome" },
                mode: params.publish_dir_mode,
                saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
            ]
        }
    }

    if (!(params.skip_qc ?: false) & !(params.skip_deseq2_qc ?: false)) {
        process {
            withName: '.*:NORMALIZE_DESEQ2_QC_ALL_GENES_ALIGNMENT' {
                publishDir = [
                    path: { "${params.outdir}/${params.aligner}/genome/deseq2/all_genes" },
                    mode: params.publish_dir_mode,
                    pattern: "*{RData,*.pca*.vals.txt,plots.pdf,*.sample.dists.txt,size_factors,log,*normalized_counts.txt,*rlog_counts.txt,scaling_dat.txt,*.read.distribution*.txt,correlation_mqc.tsv,read_dist_mqc.tsv,pca.vals_mqc.tsv,sample.dists_mqc.tsv,Read_Distribution,Quality_Control}"
                ]
            }
            withName: '.*:NORMALIZE_DESEQ2_QC_INVARIANT_GENES_ALIGNMENT' {
                publishDir = [
                    path: { "${params.outdir}/${params.aligner}/genome/deseq2/invariant_genes" },
                    mode: params.publish_dir_mode,
                    pattern: "*{RData,*.pca*.vals.txt,plots.pdf,*.sample.dists.txt,size_factors,log,normalization,*normalized_counts.txt,*normalized_filt.txt,scaling_dat.txt,*.read.distribution*.txt,correlation_mqc.tsv,read_dist_mqc.tsv,pca.vals_mqc.tsv,sample.dists_mqc.tsv,Read_Distribution,Quality_Control}"
                ]
            }
        }
    }
}

//
// Deeptools BigWig normalization options (STAR and HISAT2)
//

if ((['star', 'hisat2'].contains(params.aligner)) && !params.skip_deeptools_norm) {
    process {
        withName: '.*:DEEPTOOLS_BIGWIG_NORM_ALL_GENES' {
            publishDir = [
                path: { 
                    // Use quantification method from meta map (added dynamically in workflow)
                    // Falls back to params.quantification for single quantification method
                    def quant_method = meta.quantification ?: params.quantification
                    "${params.outdir}/${params.aligner}/${quant_method}/deeptools/all_genes" 
                },
                mode: params.publish_dir_mode,
                pattern: "*.norm.bw"
            ]
        }
        
        withName: '.*:DEEPTOOLS_BIGWIG_NORM_INVARIANT' {
            publishDir = [
                path: { 
                    // Use quantification method from meta map (added dynamically in workflow)
                    // Falls back to params.quantification for single quantification method
                    def quant_method = meta.quantification ?: params.quantification
                    "${params.outdir}/${params.aligner}/${quant_method}/deeptools/invariant_genes" 
                },
                mode: params.publish_dir_mode,
                pattern: "*.norm.bw"
            ]
        }
    }
}

//
// Deeptools BigWig normalization options for pseudo-aligners (Kallisto)
//

if (!params.skip_pseudo_alignment && params.pseudo_aligner && !params.skip_deeptools_norm) {
    process {
        withName: '.*:DEEPTOOLS_BIGWIG_NORM_ALL_GENES' {
            publishDir = [
                path: { 
                    // Pseudo-aligners don't have quantification methods like rsem/genome
                    "${params.outdir}/${params.pseudo_aligner}/deeptools/all_genes" 
                },
                mode: params.publish_dir_mode,
                pattern: "*.norm.bw"
            ]
        }
        
        withName: '.*:DEEPTOOLS_BIGWIG_NORM_INVARIANT' {
            publishDir = [
                path: { 
                    // Pseudo-aligners don't have quantification methods like rsem/genome
                    "${params.outdir}/${params.pseudo_aligner}/deeptools/invariant_genes" 
                },
                mode: params.publish_dir_mode,
                pattern: "*.norm.bw"
            ]
        }
    }
}

//
// Pseudo-alignment options
//

if (!params.skip_pseudo_alignment && params.pseudo_aligner) {
    process {
        withName: '.*:QUANTIFY_PSEUDO_ALIGNMENT:CUSTOM_TX2GENE' {
            publishDir = [
                path: { "${params.outdir}/${params.pseudo_aligner}" },
                mode: params.publish_dir_mode,
                saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
            ]
        }

        withName: '.*:QUANTIFY_PSEUDO_ALIGNMENT:TXIMETA_TXIMPORT' {
            ext.prefix = { "${quant_type}.merged" }
            publishDir = [
                path: { "${params.outdir}/${params.pseudo_aligner}" },
                mode: params.publish_dir_mode,
                saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
            ]
        }

        withName: '.*:QUANTIFY_PSEUDO_ALIGNMENT:SE_.*' {
            ext.args = '--assay_names counts,abundance'
            publishDir = [
                path: { "${params.outdir}/${params.pseudo_aligner}" },
                mode: params.publish_dir_mode,
                saveAs: { filename -> filename.equals('versions.yml') || filename.endsWith('.log') ? null : filename }
            ]
        }
        withName: '.*:QUANTIFY_PSEUDO_ALIGNMENT:SE_GENE_UNIFIED' {
            ext.prefix = { "${params.pseudo_aligner}.merged.gene" }
        }
        withName: '.*:QUANTIFY_PSEUDO_ALIGNMENT:SE_TRANSCRIPT_UNIFIED' {
            ext.prefix = { "${params.pseudo_aligner}.merged.transcript" }
        }
    }

    if (!(params.skip_qc ?: false) & !(params.skip_deseq2_qc ?: false)) {
        process {

            withName: '.*:NORMALIZE_DESEQ2_QC_ALL_GENES' {
                publishDir = [
                    path: { "${params.outdir}/${params.pseudo_aligner}/deseq2/all_genes" },
                    mode: params.publish_dir_mode,
                    pattern: "*{RData,*.pca*.vals.txt,plots.pdf,*.sample.dists.txt,size_factors,log,*normalized_counts.txt,*rlog_counts.txt,scaling_dat.txt,*.read.distribution*.txt,correlation_mqc.tsv,read_dist_mqc.tsv,pca.vals_mqc.tsv,sample.dists_mqc.tsv,Read_Distribution,Quality_Control}"
                ]
            }
            withName: '.*:NORMALIZE_DESEQ2_QC_INVARIANT_GENES' {
                publishDir = [
                    path: { "${params.outdir}/${params.pseudo_aligner}/deseq2/invariant_genes" },
                    mode: params.publish_dir_mode,
                    pattern: "*{RData,*.pca*.vals.txt,plots.pdf,*.sample.dists.txt,size_factors,log,normalization,*normalized_counts.txt,*normalized_filt.txt,scaling_dat.txt,*.read.distribution*.txt,correlation_mqc.tsv,read_dist_mqc.tsv,pca.vals_mqc.tsv,sample.dists_mqc.tsv,Read_Distribution,Quality_Control}"
                ]
            }
        }
    }
}

//
// MultiQC report generation - separate reports for each aligner
// IMPORTANT: This must be OUTSIDE the pseudo-alignment conditional block
// so it applies regardless of whether pseudo-alignment is used
//
process {
    withName: '.*:MULTIQC_STAR' {
        ext.prefix = 'multiqc_star_report'
        publishDir = [
            [
                path: { "${params.outdir}/multiqc/star" },
                mode: params.publish_dir_mode,
                pattern: '*{report.html,_data,_plots}',
                saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
            ]
        ]
    }
    
    withName: '.*:MULTIQC_HISAT2' {
        ext.prefix = 'multiqc_hisat2_report'
        publishDir = [
            [
                path: { "${params.outdir}/multiqc/hisat2" },
                mode: params.publish_dir_mode,
                pattern: '*{report.html,_data,_plots}',
                saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
            ]
        ]
    }
    
    withName: '.*:MULTIQC_KALLISTO' {
        ext.prefix = 'multiqc_kallisto_report'
        publishDir = [
            [
                path: { "${params.outdir}/multiqc/kallisto" },
                mode: params.publish_dir_mode,
                pattern: '*{report.html,_data,_plots}',
                saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
            ]
        ]
    }
}
